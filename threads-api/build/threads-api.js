"use strict";!function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}(exports,{DEFAULT_DEVICE:function(){return i},ThreadsAPI:function(){return u}});var e=require("axios"),t=require("./constants"),n=require("./dynamic-data");function r(e,t,n,r,s,a,o){try{var i=e[a](o),u=i.value}catch(e){n(e);return}i.done?t(u):Promise.resolve(u).then(r,s)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(s,a){var o=e.apply(t,n);function i(e){r(o,s,a,i,u,"next",e)}function u(e){r(o,s,a,i,u,"throw",e)}i(void 0)})}}function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function o(e,t){var n,r,s,a,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(n)throw TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(s=2&a[0]?r.return:a[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,a[1])).done)return s;switch(r=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){o.label=a[1];break}if(6===a[0]&&o.label<s[1]){o.label=s[1],s=a;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(a);break}s[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}var i={manufacturer:"OnePlus",model:"ONEPLUS+A3010",os_version:25,os_release:"7.1.1"},u=function(r){"use strict";var u=this;this.verbose=!1,this.token=void 0,this.fbLSDToken=t.DEFAULT_LSD_TOKEN,this.noUpdateToken=!1,this.noUpdateLSD=!1,this.deviceID=t.DEFAULT_DEVICE_ID,this.device=i,this.userID=void 0,this._getAppHeaders=function(){return a({"User-Agent":"Barcelona "+n.LATEST_ANDROID_APP_VERSION+" Android","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},u.token?{Authorization:"Bearer IGT:2:"+u.token}:void 0)},this._getDefaultHeaders=function(e){return a({},u._getAppHeaders(),{authority:"www.threads.net",accept:"*/*","accept-language":"ko","cache-control":"no-cache",origin:"https://www.threads.net",pragma:"no-cache","Sec-Fetch-Site":"same-origin","x-asbd-id":"129477","x-fb-lsd":u.fbLSDToken,"x-ig-app-id":"238260118697367"},e?{referer:"https://www.threads.net/@"+e}:void 0)};var c=this;this.getProfilePage=s(function(t,n,r){return o(this,function(s){switch(s.label){case 0:return[4,e.default.get(""+t+n,a({},r,{httpAgent:c.httpAgent,httpsAgent:c.httpsAgent,headers:a({},c._getDefaultHeaders(n),{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"ko,en;q=0.9,ko-KR;q=0.8,ja;q=0.7",Authorization:void 0,referer:"https://www.instagram.com/","sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"cross-site","sec-fetch-user":"?1","upgrade-insecure-requests":"1","x-asbd-id":void 0,"x-fb-lsd":void 0,"x-ig-app-id":void 0})}))];case 1:return[2,(0,s.sent().data).replace(/\s/g,"").replace(/\n/g,"")]}})});var l=this;this.getUserIDfromUsernameWithInstagram=s(function(e,t){var n,r,s,a,i;return o(this,function(o){switch(o.label){case 0:return[4,l.getProfilePage("https://www.instagram.com/",e,t)];case 1:return a=null==(n=(s=o.sent()).match(/"user_id":"(\d+)",/))?void 0:n[1],i=null==(r=s.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:r[1],!l.noUpdateLSD&&i&&(l.fbLSDToken=i,l.verbose&&console.debug("[fbLSDToken] UPDATED",l.fbLSDToken)),[2,a]}})});var d=this;this.getUserIDfromUsername=s(function(e,t){var n,r,s,a,i;return o(this,function(o){switch(o.label){case 0:return[4,d.getProfilePage("https://www.threads.net/@",e,t)];case 1:if(a=null==(n=(s=o.sent()).match(/"user_id":"(\d+)"/))?void 0:n[1],i=null==(r=s.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:r[1],!a)return[2,d.getUserIDfromUsernameWithInstagram(e,t)];return!d.noUpdateLSD&&i&&(d.fbLSDToken=i,d.verbose&&console.debug("[fbLSDToken] UPDATED",d.fbLSDToken)),[2,a]}})});var h=this;this.getCurrentUserID=s(function(e){return o(this,function(t){switch(t.label){case 0:if(h.userID)return h.verbose&&console.debug("[userID] USING",h.userID),[2,h.userID];if(!h.username)throw Error("username is not defined");return[4,h.getUserIDfromUsername(h.username,e)];case 1:return h.userID=t.sent(),h.verbose&&console.debug("[userID] UPDATED",h.userID),[2,h.userID]}})});var f=this;this.getUserProfile=s(function(t,n,r){return o(this,function(s){switch(s.label){case 0:return f.verbose&&console.debug("[fbLSDToken] USING",f.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:f.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"23996318473300828"}),a({},r,{httpAgent:f.httpAgent,httpsAgent:f.httpsAgent,headers:a({},f._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileRootQuery"})}))];case 1:return[2,s.sent().data.data.userData.user]}})});var p=this;this.getUserProfileThreads=s(function(t,n,r){var s,i;return o(this,function(o){switch(o.label){case 0:return p.verbose&&console.debug("[fbLSDToken] USING",p.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:p.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"6232751443445612"}),a({},r,{httpAgent:p.httpAgent,httpsAgent:p.httpsAgent,headers:a({},p._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileThreadsTabQuery"})}))];case 1:return[2,(null==(i=o.sent().data.data)?void 0:null==(s=i.mediaData)?void 0:s.threads)||[]]}})});var g=this;this.getUserProfileReplies=s(function(t,n,r){var s,i;return o(this,function(o){switch(o.label){case 0:return g.verbose&&console.debug("[fbLSDToken] USING",g.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:g.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"6684830921547925"}),a({},r,{httpAgent:g.httpAgent,httpsAgent:g.httpsAgent,headers:a({},g._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileRepliesTabQuery"})}))];case 1:return[2,(null==(i=o.sent().data.data)?void 0:null==(s=i.mediaData)?void 0:s.threads)||[]]}})});var v=this;this.getPostIDfromThreadID=s(function(e,t){var n;return o(this,function(r){return n="https://www.threads.net/t/"+(e=(e=(e=e.split("?")[0]).replace(/\s/g,"")).replace(/\//g,"")),[2,v.getPostIDfromURL(n,t)]})});var b=this;this.getPostIDfromURL=s(function(t,n){var r,s,i,u,c;return o(this,function(o){switch(o.label){case 0:return[4,e.default.get(t,a({httpAgent:b.httpAgent,httpsAgent:b.httpsAgent},n))];case 1:return u=null==(r=(i=(i=(i=o.sent().data).replace(/\s/g,"")).replace(/\n/g,"")).match(/{"post_id":"(.*?)"}/))?void 0:r[1],c=null==(s=i.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:s[1],!b.noUpdateLSD&&c&&(b.fbLSDToken=c,b.verbose&&console.debug("[fbLSDToken] UPDATED",b.fbLSDToken)),[2,u]}})});var D=this;this.getThreads=s(function(t,n){return o(this,function(r){switch(r.label){case 0:return D.verbose&&console.debug("[fbLSDToken] USING",D.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:D.fbLSDToken,variables:'{"postID":"'+t+'"}',doc_id:"5587632691339264"}),a({httpAgent:D.httpAgent,httpsAgent:D.httpsAgent,headers:a({},D._getDefaultHeaders(),{"x-fb-friendly-name":"BarcelonaPostPageQuery"})},n))];case 1:return[2,r.sent().data.data.data]}})});var w=this;this.getThreadLikers=s(function(t,n){return o(this,function(r){switch(r.label){case 0:return w.verbose&&console.debug("[fbLSDToken] USING",w.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:w.fbLSDToken,variables:'{"mediaID":"'+t+'"}',doc_id:"9360915773983802"}),a({},n,{httpAgent:w.httpAgent,httpsAgent:w.httpsAgent,headers:w._getDefaultHeaders()}))];case 1:return[2,r.sent().data.data.likers]}})});var A=this;this._toggleAuthPostRequest=s(function(t,n){return o(this,function(r){switch(r.label){case 0:return[4,A.getToken()];case 1:if(!r.sent())throw Error("Token not found");return[4,e.default.post(t,void 0,a({},n,{httpAgent:A.httpAgent,httpsAgent:A.httpsAgent,headers:A._getDefaultHeaders()}))];case 2:return[2,r.sent()]}})});var m=this;this.like=s(function(e,n){var r;return o(this,function(s){switch(s.label){case 0:return[4,m.getCurrentUserID()];case 1:return r=s.sent(),[4,m._toggleAuthPostRequest(t.BASE_API_URL+"/media/"+e+"_"+r+"/like/",n)];case 2:return[2,"ok"===s.sent().data.status]}})});var k=this;this.unlike=s(function(e,n){var r;return o(this,function(s){switch(s.label){case 0:return[4,k.getCurrentUserID()];case 1:return r=s.sent(),[4,k._toggleAuthPostRequest(t.BASE_API_URL+"/media/"+e+"_"+r+"/unlike/",n)];case 2:return[2,"ok"===s.sent().data.status]}})});var S=this;this.follow=s(function(e,n){var r;return o(this,function(s){switch(s.label){case 0:return[4,S._toggleAuthPostRequest(t.BASE_API_URL+"/friendships/create/"+e+"/",n)];case 1:return r=s.sent(),S.verbose&&console.debug("[FOLLOW]",r.data),[2,r.data]}})});var _=this;this.unfollow=s(function(e,n){var r;return o(this,function(s){switch(s.label){case 0:return[4,_._toggleAuthPostRequest(t.BASE_API_URL+"/friendships/destroy/"+e+"/",n)];case 1:return r=s.sent(),_.verbose&&console.debug("[UNFOLLOW]",r.data),[2,r.data]}})});var L=this;this.getToken=s(function(){var n,r,s,a,i;return o(this,function(o){switch(o.label){case 0:if(L.token)return L.verbose&&console.debug("[token] USING",L.token),[2,L.token];if(!L.username||!L.password)throw Error("Username and password are required");return n=encodeURIComponent(JSON.stringify({client_input_params:{password:L.password,contact_point:L.username,device_id:""+L.deviceID},server_params:{credential_type:"password",device_id:""+L.deviceID}})),s=encodeURIComponent(JSON.stringify({bloks_version:r="5f56efad68e1edec7801f630b5c122704ec5378adbee6609a448f105f34a9c73",styles_id:"instagram"})),a={method:"POST",headers:L._getAppHeaders(),responseType:"text",data:"params="+n+"&bk_client_context="+s+"&bloks_versioning_id="+r},[4,(0,e.default)(t.LOGIN_URL,a)];case 1:return i=o.sent().data.split("Bearer IGT:2:")[1].split('"')[0].replaceAll("\\",""),L.noUpdateToken||(L.verbose&&console.debug("[token] UPDATED",i),L.token=i),[2,i]}})});var T=this;this.delete=s(function(n,r){var s,i;return o(this,function(o){switch(o.label){case 0:return s=t.BASE_API_URL+"/media/"+n+"/delete/",i="signed_body=SIGNATURE."+encodeURIComponent(JSON.stringify({media_id:n,_uid:T.userID,_uuid:T.deviceID})),[4,e.default.post(s,i,a({httpAgent:T.httpAgent,httpsAgent:T.httpsAgent,headers:T._getAppHeaders(),timeout:6e4},r))];case 1:if("ok"===o.sent().data.status)return[2,!0];return[2,!1]}})}),(null==r?void 0:r.token)&&(this.token=r.token),(null==r?void 0:r.fbLSDToken)&&(this.fbLSDToken=r.fbLSDToken),this.noUpdateToken=!!(null==r?void 0:r.noUpdateToken),this.noUpdateLSD=!!(null==r?void 0:r.noUpdateLSD),this.verbose=(null==r?void 0:r.verbose)||!1,this.httpAgent=null==r?void 0:r.httpAgent,this.httpsAgent=null==r?void 0:r.httpsAgent,this.username=null==r?void 0:r.username,this.password=null==r?void 0:r.password,(null==r?void 0:r.deviceID)&&(this.deviceID=r.deviceID),this.device=null==r?void 0:r.device,this.userID=null==r?void 0:r.userID};